{% extends 'base/base.html' %}
{% load static %}
{% load i18n %}

{% block title %}{% trans "Distribuidora KERIM S.A.C" %}{% endblock %}

{% block content %}
<div id="dashboardContainer" class="flex h-screen overflow-hidden bg-gray-100">

  <!-- Sidebar -->
  <aside id="sidebar" class="w-64 bg-white shadow-md transition-all flex flex-col justify-between z-40">
    <div>
      <div class="text-center mt-4">
        <img src="{% static 'img/logo.png' %}" class="mx-auto w-20 mb-2" alt="Logo Distribuidora">
        <h5 class="text-blue-700 font-bold text-sm">Distribuidora KERIM S.A.C</h5>
      </div>

      {% with user_role=user.profile.role.role_type ns=request.resolver_match.namespace url_name=request.resolver_match.url_name path=request.path %}
      <ul class="mt-6 space-y-4 px-6"
          x-data="{ openTransport: {% if 'transport' in path %}true{% else %}false{% endif %} }">

        <!-- Inicio -->
        <li>
          <a href="{% url 'dashboard' %}"
             class="flex items-center space-x-2 p-2 rounded-lg shadow transition font-medium
                    {% if request.path == '/dashboard/' %}bg-black text-white{% else %}text-gray-700 hover:bg-black hover:text-white{% endif %}">
            <i class="bi bi-house-door"></i><span class="text-base">Inicio</span>
          </a>
        </li>

        <!-- Usuarios (solo superusuario) -->
        {% if user.is_superuser %}
        <li x-data="{ openUsers: {% if url_name == 'list' or url_name == 'employee_list' %}true{% else %}false{% endif %} }">
          <button @click="openUsers = !openUsers"
                  type="button"
                  class="w-full flex items-center justify-between p-2 rounded-lg shadow transition font-medium
                         {% if url_name == 'list' or url_name == 'employee_list' %}bg-black text-white{% else %}text-gray-700 hover:bg-black hover:text-white{% endif %}">
            <span class="flex items-center space-x-2">
              <i class="bi bi-people"></i><span class="text-base">Usuarios</span>
            </span>
            <i class="bi" :class="openUsers ? 'bi-chevron-up' : 'bi-chevron-down'"></i>
          </button>

          <ul x-show="openUsers" x-transition class="pl-6 mt-2 space-y-2 origin-top">

            <li>
              <a href="{% url 'users:list' %}"
                 class="block px-2 py-1.5 rounded transition {% if url_name == 'list' %}bg-black text-white{% else %}text-gray-700 hover:bg-gray-100{% endif %}">
                <i class="bi bi-person-fill me-2"></i>Usuarios
              </a>
            </li>
            <li>
              <a href="{% url 'users:employee_list' %}"
                 class="block px-2 py-1.5 rounded transition {% if url_name == 'employee_list' %}bg-black text-white{% else %}text-gray-700 hover:bg-gray-100{% endif %}">
                <i class="bi bi-person-vcard me-2"></i>Empleados
              </a>
            </li>

          </ul>
        </li>
        {% endif %}

        <!-- Transporte -->
        {% if user.is_superuser or user_role in 'ops_manager warehouse_manager dispatcher driver viewer' %}
        <li>
          <button @click="openTransport = !openTransport"
                  type="button"
                  class="w-full flex items-center justify-between p-2 rounded-lg shadow transition font-medium
                         {% if 'transport' in path %}bg-black text-white{% else %}text-gray-700 hover:bg-black hover:text-white{% endif %}">
            <span class="flex items-center space-x-2">
              <i class="bi bi-truck"></i><span class="text-base">Transporte</span>
            </span>
            <i class="bi" :class="openTransport ? 'bi-chevron-up' : 'bi-chevron-down'"></i>
          </button>

          <ul x-show="openTransport" x-transition class="pl-6 mt-2 space-y-2 origin-top">

            {% if user.is_superuser or user_role in 'ops_manager warehouse_manager viewer' %}
              <li><a href="{% url 'transport:vehicle_list' %}"
                     class="block px-2 py-1 rounded transition {% if 'vehicle' in path %}bg-black text-white{% else %}hover:bg-gray-200{% endif %}">
                Vehículos</a></li>
              <li><a href="{% url 'transport:driver_list' %}"
                     class="block px-2 py-1 rounded transition {% if 'driver' in path %}bg-black text-white{% else %}hover:bg-gray-200{% endif %}">
                Conductores</a></li>
            {% endif %}

            {% if user.is_superuser or user_role in 'ops_manager dispatcher driver viewer' %}
              <li><a href="{% url 'transport:route_list' %}"
                     class="block px-2 py-1 rounded transition {% if 'route' in path %}bg-black text-white{% else %}hover:bg-gray-200{% endif %}">
                Rutas</a></li>
              <li><a href="{% url 'transport:trip_list' %}"
                     class="block px-2 py-1 rounded transition {% if 'trip' in path %}bg-black text-white{% else %}hover:bg-gray-200{% endif %}">
                Viajes</a></li>
              <li><a href="{% url 'transport:stop_list_all' %}"
                     class="block px-2 py-1 rounded transition {% if 'stop' in path %}bg-black text-white{% else %}hover:bg-gray-200{% endif %}">
                Paradas</a></li>
              <li><a href="{% url 'transport:incident_list' %}"
                     class="block px-2 py-1 rounded transition {% if 'incident' in path %}bg-black text-white{% else %}hover:bg-gray-200{% endif %}">
                Incidentes</a></li>
            {% endif %}

            {% if user.is_superuser or user_role == 'ops_manager' %}
              <li><a href="{% url 'transport:expense_list' %}"
                     class="block px-2 py-1 rounded transition {% if 'expense' in path %}bg-black text-white{% else %}hover:bg-gray-200{% endif %}">
                Gastos</a></li>
            {% endif %}

          </ul>
        </li>
        {% endif %}

        <!-- Inventario -->
        {% if user.is_superuser or user_role in "ops_manager warehouse_manager warehouse_staff inventory_controller viewer" %}
        <li x-data="{ openInventory: {% if ns == 'product_categories' or ns == 'inventory_product' or ns == 'inventory_stock' or ns == 'inventory_receiving' or ns == 'inventory_movements' or ns == 'inventory_adjustments' or ns == 'inventory_alerts' or ns == 'inventory_kardex' or ns == 'suppliers' %}true{% else %}false{% endif %} }">

          <button @click="openInventory = !openInventory"
                  type="button"
                  class="w-full flex items-center justify-between p-2 rounded-lg shadow transition font-medium
                         {% if ns == 'product_categories' or ns == 'inventory_product' or ns == 'inventory_stock' or ns == 'inventory_receiving' or ns == 'inventory_movements' or ns == 'inventory_adjustments' or ns == 'inventory_alerts' or ns == 'inventory_kardex' %}
                           bg-black text-white
                         {% else %}
                           text-gray-700 hover:bg-black hover:text-white
                         {% endif %}">
            <span class="flex items-center space-x-2">
              <i class="bi bi-box-seam"></i><span class="text-base">Inventario</span>
            </span>
            <i class="bi" :class="openInventory ? 'bi-chevron-up' : 'bi-chevron-down'"></i>
          </button>

          <ul x-show="openInventory" x-transition class="pl-4 mt-2 space-y-1 origin-top">

            <!-- Configuración -->
            <li class="text-xs text-gray-400 uppercase tracking-wider mt-3">Configuración</li>

            {% if user.is_superuser or user_role in "ops_manager warehouse_manager inventory_controller viewer" %}
            <li>
              <a href="{% url 'product_categories:category_list' %}"
                 class="block px-2 py-1.5 rounded transition {% if ns == 'product_categories' %}bg-black text-white{% else %}text-gray-700 hover:bg-gray-100{% endif %}">
                Categorías
              </a>
            </li>
            <li>
              <a href="{% url 'inventory_product:product_list' %}"
                 class="block px-2 py-1.5 rounded transition {% if ns == 'inventory_product' %}bg-black text-white{% else %}text-gray-700 hover:bg-gray-100{% endif %}">
                Productos
              </a>
            </li>
            <li>
              <a href="{% url 'inventory_stock:location_list' %}"
                 class="block px-2 py-1.5 rounded transition {% if url_name == 'location_list' or url_name == 'location_create' or url_name == 'location_update' or url_name == 'location_delete' %}bg-black text-white{% else %}text-gray-700 hover:bg-gray-100{% endif %}">
                Ubicaciones
              </a>
            </li>
            <li>
              <a href="{% url 'suppliers:supplier_list' %}"
                 class="block px-2 py-1.5 rounded transition {% if url_name == 'supplier_list' or url_name == 'supplier_create' or url_name == 'supplier_update' or url_name == 'supplier_delete' %}bg-black text-white{% else %}text-gray-700 hover:bg-gray-100{% endif %}">
                Proveedores
              </a>
            </li>
            {% endif %}

            <!-- Operaciones -->
            <li class="text-xs text-gray-400 uppercase tracking-wider mt-3">Operaciones</li>

            {% if user.is_superuser or user_role in "ops_manager warehouse_manager warehouse_staff inventory_controller viewer" %}
            <li>
              <a href="{% url 'inventory_receiving:reception_list' %}"
                 class="block px-2 py-1.5 rounded transition {% if ns == 'inventory_receiving' %}bg-black text-white{% else %}text-gray-700 hover:bg-gray-100{% endif %}">
                Recepciones
              </a>
            </li>
            <li>
              <a href="{% url 'inventory_movements:movement_list' %}"
                 class="block px-2 py-1.5 rounded transition {% if ns == 'inventory_movements' %}bg-black text-white{% else %}text-gray-700 hover:bg-gray-100{% endif %}">
                Movimientos
              </a>
            </li>
            {% endif %}

            {% if user.is_superuser or user_role in "ops_manager warehouse_manager inventory_controller viewer" %}
            <li>
              <a href="{% url 'inventory_adjustments:adjustment_list' %}"
                 class="block px-2 py-1.5 rounded transition {% if ns == 'inventory_adjustments' %}bg-black text-white{% else %}text-gray-700 hover:bg-gray-100{% endif %}">
                Ajustes
              </a>
            </li>
            {% endif %}

            <!-- Consultas -->
            <li class="text-xs text-gray-400 uppercase tracking-wider mt-3">Consultas</li>

            {% if user.is_superuser or user_role in "ops_manager warehouse_manager inventory_controller viewer" %}
            <li>
              <a href="{% url 'inventory_stock:stock_list' %}"
                 class="block px-2 py-1.5 rounded transition {% if url_name == 'stock_list' or url_name == 'stock_create' or url_name == 'stock_update' or url_name == 'stock_delete' %}bg-black text-white{% else %}text-gray-700 hover:bg-gray-100{% endif %}">
                Stock por Ubicación
              </a>
            </li>
            <li>
              <a href="{% url 'inventory_alerts:alert_list' %}"
                 class="block px-2 py-1.5 rounded transition {% if ns == 'inventory_alerts' %}bg-black text-white{% else %}text-gray-700 hover:bg-gray-100{% endif %}">
                Alertas de Stock
              </a>
            </li>
            <li>
              <a href="{% url 'inventory_kardex:kardex_list' %}"
                 class="block px-2 py-1.5 rounded transition {% if ns == 'inventory_kardex' %}bg-black text-white{% else %}text-gray-700 hover:bg-gray-100{% endif %}">
                Kardex
              </a>
            </li>
            {% endif %}
          </ul>
        </li>
        {% endif %}

        <!-- Reportes -->
        {% if user.is_superuser or user_role in "ops_manager warehouse_manager warehouse_staff inventory_controller dispatcher driver viewer" %}
        <li x-data="{ openReports: {% if ns == 'reports' %}true{% else %}false{% endif %} }">
          <button @click="openReports = !openReports"
                  type="button"
                  class="w-full flex items-center justify-between p-2 rounded-lg shadow transition font-medium
                         {% if ns == 'reports' %}
                           bg-black text-white
                         {% else %}
                           text-gray-700 hover:bg-black hover:text-white
                         {% endif %}">
            <span class="flex items-center space-x-2">
              <i class="bi bi-graph-up"></i><span class="text-base">Reportes</span>
            </span>
            <i class="bi" :class="openReports ? 'bi-chevron-up' : 'bi-chevron-down'"></i>
          </button>

          <ul x-show="openReports" x-transition class="pl-4 mt-2 space-y-1 origin-top">

            <!-- Transporte -->
            <li class="text-xs text-gray-400 uppercase tracking-wider mt-3">Transporte</li>
            <li><a href="{% url 'reports:trips_report' %}"
                   class="block px-2 py-1.5 rounded transition {% if url_name == 'trips_report' %}bg-black text-white{% else %}text-gray-700 hover:bg-gray-100{% endif %}">
                   Viajes</a></li>
            <li><a href="{% url 'reports:incidents_report' %}"
                   class="block px-2 py-1.5 rounded transition {% if url_name == 'incidents_report' %}bg-black text-white{% else %}text-gray-700 hover:bg-gray-100{% endif %}">
                   Incidentes</a></li>
            <li><a href="{% url 'reports:expenses_report' %}"
                   class="block px-2 py-1.5 rounded transition {% if url_name == 'expenses_report' %}bg-black text-white{% else %}text-gray-700 hover:bg-gray-100{% endif %}">
                   Gastos</a></li>

            <!-- Inventario -->
            <li class="text-xs text-gray-400 uppercase tracking-wider mt-3">Inventario</li>
            <li><a href="{% url 'reports:receptions_report' %}"
                   class="block px-2 py-1.5 rounded transition {% if url_name == 'receptions_report' %}bg-black text-white{% else %}text-gray-700 hover:bg-gray-100{% endif %}">
                   Recepciones</a></li>
            <li><a href="{% url 'reports:movements_report' %}"
                   class="block px-2 py-1.5 rounded transition {% if url_name == 'movements_report' %}bg-black text-white{% else %}text-gray-700 hover:bg-gray-100{% endif %}">
                   Movimientos</a></li>
            <li><a href="{% url 'reports:adjustments_report' %}"
                   class="block px-2 py-1.5 rounded transition {% if url_name == 'adjustments_report' %}bg-black text-white{% else %}text-gray-700 hover:bg-gray-100{% endif %}">
                   Ajustes</a></li>
            <li><a href="{% url 'reports:stock_report' %}"
                   class="block px-2 py-1.5 rounded transition {% if url_name == 'stock_report' %}bg-black text-white{% else %}text-gray-700 hover:bg-gray-100{% endif %}">
                   Stock</a></li>
            <li><a href="{% url 'reports:alerts_report' %}"
                   class="block px-2 py-1.5 rounded transition {% if url_name == 'alerts_report' %}bg-black text-white{% else %}text-gray-700 hover:bg-gray-100{% endif %}">
                   Alertas</a></li>
            <li><a href="{% url 'reports:kardex_report' %}"
                   class="block px-2 py-1.5 rounded transition {% if url_name == 'kardex_report' %}bg-black text-white{% else %}text-gray-700 hover:bg-gray-100{% endif %}">
                   Kardex</a></li>

            <!-- Proveedores -->
            <li class="text-xs text-gray-400 uppercase tracking-wider mt-3">Proveedores</li>
            <li><a href="{% url 'reports:suppliers_report' %}"
                   class="block px-2 py-1.5 rounded transition {% if url_name == 'suppliers_report' %}bg-black text-white{% else %}text-gray-700 hover:bg-gray-100{% endif %}">
                   Listado</a></li>
          </ul>
        </li>
        {% endif %}

        <!-- Perfil -->
        <li>
          <a href="{% url 'users:profile_update' %}"
             class="flex items-center space-x-2 p-2 rounded-lg shadow transition font-medium
                    {% if request.path == '/users/perfil/' %}
                      bg-black text-white
                    {% else %}
                      text-gray-700 hover:bg-black hover:text-white
                    {% endif %}">
            <i class="bi bi-person-badge"></i>
            <span class="text-base">Perfil</span>
          </a>
        </li>

      </ul>
      {% endwith %}
    </div>

    <!-- Botón de salida -->
    <form method="post" action="{% url 'logout' %}" class="p-6">
      {% csrf_token %}
      <button type="submit" class="w-full bg-red-600 hover:bg-red-700 text-white font-semibold py-2 px-4 rounded-lg shadow transition">
        <i class="bi bi-box-arrow-left me-2"></i>Salir
      </button>
    </form>
  </aside>

  <!-- Contenido principal -->
  <div class="flex-1 flex flex-col">
    <!-- Navbar superior -->
    <header class="bg-white border-b shadow px-6 py-3 flex items-center justify-between">
      <div class="flex items-center space-x-4">
        <button id="toggleSidebar" class="text-gray-700 text-2xl focus:outline-none transition hover:scale-105">☰</button>
        <span class="text-sm text-gray-800 font-medium">Bienvenido, {{ user.first_name }} {{ user.last_name }}</span>
      </div>
    </header>

    <!-- Contenido interno -->
    <main id="content" class="flex-1 overflow-y-auto p-6 bg-gray-100">
      {% block inner_content %}{% endblock %}
    </main>
  </div>
</div>
{% endblock %}
